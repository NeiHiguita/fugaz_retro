@model IEnumerable<fugaz_retro.Models.Proveedor>
@using System.Text.Json

@{
    ViewData["Title"] = "Proveedores";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Diccionario para mapear nombres de propiedades a nombres de encabezados deseados
    Dictionary<string, string> headerNames = new Dictionary<string, string>
    {
        { "TipoProveedor", "Tipo Proveedor" },
        { "Telefono", "Teléfono" },
        { "Direccion", "Dirección" },
        { "Estado", "Estado" },
        { "Id_Proveedor", "ID Proveedor" } // Añadimos la entrada para Id_Proveedor
    };
}

<div class="tbl table-responsive">
    <h1>Proveedores</h1>

    <div class="row mb-3">
        <div class="col">
            <a asp-action="Create" class="btn btn-success">Crear Proveedor <img src="/Images/agregar.png" height="24px" alt="Alternate Text" /></a>
        </div>
    </div>
    <style>
        .center-header, .center-content {
            text-align: center;
        }

        .form-switch {
            display: flex;
            justify-content: center;
        }
    </style>

    <table class="table table-striped table-bordered text-center" id="Table">
        <thead class="thead-dark">
            <tr>
                @foreach (var property in typeof(fugaz_retro.Models.Proveedor).GetProperties())
                {
                    if (headerNames.ContainsKey(property.Name))
                    {
                        <th class="center-header">
                            @headerNames[property.Name]
                        </th>
                    }
                }
                <th class="center-header">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    @foreach (var property in typeof(fugaz_retro.Models.Proveedor).GetProperties())
                    {
                        if (headerNames.ContainsKey(property.Name))
                        {
                            <td class="center-content">
                                @if (property.Name == "Estado") // Verifica si la propiedad es "Estado"
                                {
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="toggleSwitch_@item.IdProveedor" onchange="toggleStatus(@item.IdProveedor)" @(item.Estado ? "checked" : "")>
                                        <label class="form-check-label" for="toggleSwitch_@item.IdProveedor"></label>
                                    </div>
                                }   
                                else
                                {
                                    @property.GetValue(item)
                                }
                            </td>
                        }
                    }
                    <td class="center-content">
                        <a asp-action="Edit" asp-route-id="@item.IdProveedor"><i class="fas fa-pencil-alt" style="color: green; font-size: 22px; margin-right: 20px"></i></a>
                        <a asp-action="Details" asp-route-id="@item.IdProveedor"><i class="fas fa-eye" style="color: #285d86; font-size: 22px; margin-right: 20px"></i></a>
@*                         <a href="javascript:void(0);" onclick="showDeleteModal('@item.IdProveedor', '@item.NombreCompleto')"><i class="fas fa-trash-alt mx-1" style="color: #bf0808; font-size: 22px"></i></a>
 *@                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Modal de Confirmación -->
<div class="modal fade alinmodal" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmación de Eliminación</h5>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que quieres eliminar este proveedor?</p>
                <div>
                    <dl class="row">
                        <dt class="col-sm-4">Nombre del proveedor:</dt>
                        <dd class="col-sm-8" id="proveedorName"></dd>
                    </dl>
                </div>
                <div class="alert alert-danger d-none" id="deleteError"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmDelete">Eliminar</button>
            </div>
        </div>
    </div>
</div>
<!--Link-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" />
<link rel="stylesheet" href="~/css/site.css" />
@section Scripts {
    <script>
        function showDeleteModal(id, name) {
            $('#proveedorName').text(name);
            $('#btnConfirmDelete').attr('data-id', id);
            $('#deleteModal').modal('show');
        }

        $(document).ready(function () {
            $('#btnConfirmDelete').click(function () {
                var id = $(this).data('id');
                $.ajax({
                    url: '@Url.Action("DeleteProveedor", "Proveedors")',
                    type: 'POST',
                    data: { id: id },
                    success: function (result) {
                        $('#deleteModal').modal('hide');
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        if (xhr.status == 400) {
                            $('#deleteError').text(xhr.responseText).removeClass('d-none');
                        } else {
                            $('#deleteError').text("Ocurrió un error al intentar eliminar el proveedor.").removeClass('d-none');
                        }
                    }
                });
            });

            $('.btn-secondary').click(function () {
                $('#deleteModal').modal('hide');
            });
        });

        function toggleEstado(id) {
            $.ajax({
                url: '@Url.Action("ToggleEstado", "Proveedors")',
                type: 'POST',
                data: { id: id },
                success: function (result) {
                    location.reload();
                },
                error: function (xhr, status, error) {
                    alert("Ocurrió un error al intentar cambiar el estado.");
                }
            });
        }
    </script>
}